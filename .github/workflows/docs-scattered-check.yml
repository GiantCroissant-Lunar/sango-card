name: Documentation - Scattered Docs Check

on:
  pull_request:
    paths:
      - '**.md'
  push:
    branches:
      - main
    paths:
      - '**.md'

jobs:
  check-scattered-docs:
    name: Detect Scattered Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for scattered documentation
        shell: bash
        run: |
          set -e

          echo "üîç Checking for scattered documentation files..."
          echo ""

          # Define allowed patterns (same as pre-commit hook)
          ALLOWED_PATTERNS=(
            "^README\.md$"
            "^AGENTS\.md$"
            "^CLAUDE\.md$"
            "^CODE_OF_CONDUCT\.md$"
            "^CONTRIBUTING\.md$"
            "^LICENSE\.md$"
            "^CHANGELOG\.md$"
            "^docs/"
            "^\.agent/"
            "^\.github/"
            "^\.specify/"
            "^\.windsurf/"
            "^\.gemini/"
            ".*/README\.md$"
            ".*/LICENSE\.md$"
            ".*/CHANGELOG\.md$"
            "^build/preparation/.*\.md$"
            "^projects/client/.*\.md$"
            "^packages/.*/dotnet~/.*\.md$"
          )

          # Find all markdown files
          SCATTERED_DOCS=()

          while IFS= read -r file; do
            IS_ALLOWED=false

            for pattern in "${ALLOWED_PATTERNS[@]}"; do
              if echo "$file" | grep -qE "$pattern"; then
                IS_ALLOWED=true
                break
              fi
            done

            if [ "$IS_ALLOWED" = false ]; then
              SCATTERED_DOCS+=("$file")
            fi
          done < <(find . -type f -name "*.md" ! -path "*/node_modules/*" ! -path "*/.git/*")

          if [ ${#SCATTERED_DOCS[@]} -eq 0 ]; then
            echo "‚úÖ No scattered documentation found!"
            echo ""
            echo "All markdown files are in canonical locations."
            exit 0
          fi

          # Found scattered docs - fail the check
          echo "‚ùå ERROR: Scattered documentation detected!"
          echo ""
          echo "The following markdown files are in non-canonical locations:"
          echo ""

          for doc in "${SCATTERED_DOCS[@]}"; do
            echo "  - $doc"
          done

          echo ""
          echo "üìö Documentation must be in canonical locations:"
          echo "  ‚úÖ New docs        ‚Üí docs/_inbox/"
          echo "  ‚úÖ Guides          ‚Üí docs/guides/"
          echo "  ‚úÖ Specifications  ‚Üí docs/specs/"
          echo "  ‚úÖ RFCs            ‚Üí docs/rfcs/"
          echo "  ‚úÖ ADRs            ‚Üí docs/adrs/"
          echo "  ‚úÖ Plans           ‚Üí docs/plans/"
          echo "  ‚úÖ Findings        ‚Üí docs/findings/"
          echo "  ‚úÖ Obsolete docs   ‚Üí docs/archive/"
          echo ""
          echo "üìñ See: docs/DOCUMENTATION-SCHEMA.md"
          echo "üìñ See: .agent/base/40-documentation.md (R-DOC-001)"
          echo ""
          echo "üîß To fix:"
          echo "  1. Move files to proper location (usually docs/_inbox/)"
          echo "  2. Add YAML front-matter (see docs/DOCUMENTATION-SCHEMA.md)"
          echo "  3. Run: python scripts/docs_validate.py"
          echo ""

          exit 1

      - name: Comment on PR (if scattered docs found)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ‚ùå Scattered Documentation Detected

            This PR contains markdown files in non-canonical locations. Please move them to the proper documentation structure.

            ### üìö Required Locations:
            - **New docs** ‚Üí \`docs/_inbox/\`
            - **Guides** ‚Üí \`docs/guides/\`
            - **Specifications** ‚Üí \`docs/specs/\`
            - **RFCs** ‚Üí \`docs/rfcs/\`
            - **ADRs** ‚Üí \`docs/adrs/\`
            - **Plans** ‚Üí \`docs/plans/\`
            - **Findings** ‚Üí \`docs/findings/\`
            - **Obsolete docs** ‚Üí \`docs/archive/\`

            ### üìñ Documentation:
            - [Documentation Schema](docs/DOCUMENTATION-SCHEMA.md)
            - [Agent Rules](.agent/base/40-documentation.md) (R-DOC-001)

            ### üîß How to Fix:
            1. Move scattered markdown files to \`docs/_inbox/\`
            2. Add YAML front-matter (see schema)
            3. Run \`python scripts/docs_validate.py\` locally
            4. Push changes

            <sub>ü§ñ This check prevents documentation sprawl - see the [docs scattered check workflow](.github/workflows/docs-scattered-check.yml)</sub>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
