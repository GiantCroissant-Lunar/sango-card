# Build-Time Reporting Handover

This document summarizes the build-time reporting integration across NUKE, the .NET reporting library, and the Unity build package.

## Overview
- **Scope**: Build-time reports (JSON/Markdown) generated by NUKE and the Unity post-build hook.
- **Libraries**: `Reporting.Abstractions`, `Reporting.Core`, `Reporting.Cli` under `dotnet/report/`.
- **Build drivers**: NUKE component `IReportBuild`, Unity package `com.contractwork.sangocard.build`.
- **Key constraint**: No direct edits to `projects/client/` (R-BLD-060). Unity integration is via the dedicated build package hooks.

## Artifacts Layout
- **Reports**: `build/_artifacts/<version>/build/report/*.json|*.md`
- **NuGet packages**: `build/_artifacts/<version>/nuget-packages/*.nupkg`

## Versioning
- Unified version is the repository **EffectiveVersion**.
- Sourced from:
  - `ReportVersionSuffix` if provided, else
  - `GitVersion` (`NuGetVersionV2` → `SemVer` → `InformationalVersion`), else
  - Fallback to `local` (when running locally) or `ci` (when running on CI).
- Recommendation: Install GitVersion.Tool to avoid `local/ci` fallback for production builds.

## NUKE Integration
- File: `build/nuke/build/Components/IReportBuild.cs`
- Important members:
  - `ReportArtifactsRoot`: `build/_artifacts/`
  - `ReportPackagesOutput`: `build/_artifacts/<version>/nuget-packages/`
  - `ReportDocumentsOutput`: `build/_artifacts/<version>/build/report/`
  - `ReportingCliProject`: `dotnet/report/Reporting.Cli/Reporting.Cli.csproj`
- Targets:
  - `CleanReport` → `RestoreReport` → `BuildReport` → `TestReport` → `PackReport`
  - `GenerateReport` (real) → writes JSON/MD via `Reporting.Cli`
  - `GenerateReportDryRun` (dry-run) → writes minimal JSON/MD directly (robust even without CLI)
  - `ReportFull` → `CleanReport`, `BuildReport`, `TestReport`, `PackReport`, `GenerateReport`
- Unity orchestration (partial): `build/nuke/build/Build.UnityBuild.cs`
  - `BuildClient` depends on `((IUnityBuild)this).BuildUnity`, `((IReportBuild)this).PackReport`, `((IReportBuild)this).GenerateReport`

## CLI Integration
- Project: `dotnet/report/Reporting.Cli/`
- Purpose: Headless generation of JSON/Markdown reports.
- Options:
  - `--output <dir>` (required)
  - `--artifacts-version <version>` (optional; supplied by NUKE)
  - `--formats [json|md]...` (default both)
  - `--dry-run` (optional)
  - `--name <base>` (default `build-info`)
- Note: The CLI option `--version` is intentionally not used to avoid collision with System.CommandLine built-in `--version`.

## Unity Build Package Integration
- File: `packages/scoped-6571/com.contractwork.sangocard.build/Editor/Core/Report/PostprocessBuildWithReport.cs`
  - Post-build hook writes a Unity build summary to `build/_artifacts/<version>/build/report/`.
  - Version is resolved from the Editor command line argument `--buildVersion` (passed by NUKE). Falls back to `local` if missing.
- Pre-build diagnostic: `PreprocessBuildWithReport.cs` logs environment details (e.g., `JAVA_HOME`).

## How To Run
- From repo root, NUKE dry-run (uses GitVersion if present; else falls back to `local`):
```powershell
# Dry-run build-time report
dotnet run --project build/nuke/build/_build.csproj -- GenerateReportDryRun
```
- Real build-time report:
```powershell
dotnet run --project build/nuke/build/_build.csproj -- GenerateReport
```
- Full report pipeline (clean→build→test→pack→report):
```powershell
dotnet run --project build/nuke/build/_build.csproj -- ReportFull
```
- Unity client build + reports (Unity must be configured):
```powershell
# Will build Unity, pack report libraries, and generate report documents
dotnet run --project build/nuke/build/_build.csproj -- BuildClient
```
- Verify outputs:
```powershell
Get-ChildItem -Recurse -File build/_artifacts |
  Sort-Object LastWriteTime -Descending |
  Select-Object -First 15 FullName,Length,LastWriteTime
```

## Troubleshooting
- **GitVersion missing**
  - Symptom: NUKE warning "Could not inject value for Build.GitVersion"; version folder becomes `local`/`ci`.
  - Fix: Install `GitVersion.Tool` for NUKE.
    ```powershell
    nuke :add-package GitVersion.Tool --version 6.4.0
    ```
- **System.CommandLine `--version` collision**
  - Use CLI option `--artifacts-version` instead of `--version`.
- **Running from build folder**
  - `IReportBuild` resolves `RepoRoot` and paths robustly; no action needed.

## Key File Changes
- `build/nuke/build/Components/IReportBuild.cs`
  - Added output path properties and report targets (`GenerateReport`, `GenerateReportDryRun`).
  - Robust repo path resolution (`RepoRoot`).
  - Fallback versioning and direct dry-run writers (JSON/MD) for reliability.
- `build/nuke/build/Build.UnityBuild.cs`
  - `BuildClient` depends explicitly on interface targets.
- `dotnet/report/Reporting.Core/Reporting.Core.csproj`
  - Multi-target: `netstandard2.1;net6.0` (runtime vs build-time support).
- `dotnet/report/Reporting.Cli/`
  - CLI app with `--artifacts-version` and `--dry-run` support.
- `packages/scoped-6571/com.contractwork.sangocard.build/Editor/Core/Report/PostprocessBuildWithReport.cs`
  - Writes Unity build summaries to versioned artifacts.

## Next Steps
- **Install GitVersion.Tool** to enable semantic version folders instead of `local`/`ci`.
- **Run real report generation** (`GenerateReport`) and validate outputs.
- **Run `BuildClient`** to integrate Unity postprocess output alongside NUKE reports.
- (Optional) Strengthen `Reporting.Cli` templates to include richer build metadata.

---
Maintainer notes:
- This integration follows the agreed artifacts layout and respects rule R-BLD-060 (no direct edits under `projects/client/`).
- Dry-run path is robust and does not require full solution wiring or CLI availability.
